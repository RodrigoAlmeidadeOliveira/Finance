<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Financeiro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'http://localhost:5000/api';

        // API Client
        const api = axios.create({
            baseURL: API_URL,
            headers: { 'Content-Type': 'application/json' }
        });

        api.interceptors.request.use(config => {
            const token = localStorage.getItem('access_token');
            if (token) {
                config.headers.Authorization = `Bearer ${token}`;
            }
            return config;
        });

        // Login Page
        function LoginPage({ onLoginSuccess }) {
            const [email, setEmail] = useState('admin@planner.com');
            const [password, setPassword] = useState('admin123');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    // Usar dev-login para credenciais padr√£o de desenvolvimento
                    const isDevCredentials = email === 'admin@planner.com' && password === 'admin123';
                    const response = isDevCredentials
                        ? await api.get('/auth/dev-login')
                        : await api.post('/auth/login', { email, password });

                    const { access_token, refresh_token, user } = response.data;

                    localStorage.setItem('access_token', access_token);
                    localStorage.setItem('refresh_token', refresh_token);
                    localStorage.setItem('user', JSON.stringify(user));

                    onLoginSuccess(user);
                } catch (err) {
                    setError(err.response?.data?.error || 'Erro ao fazer login');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                        <h1 className="text-3xl font-bold text-center mb-8 text-blue-600">
                            üí∞ Planner Financeiro
                        </h1>

                        <form onSubmit={handleLogin} className="space-y-6">
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                    {error}
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium mb-2">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">Senha</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition"
                            >
                                {loading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Dashboard Page
        function DashboardPage({ user, onLogout, onNavigate }) {
            const [batches, setBatches] = useState([]);
            const [loading, setLoading] = useState(true);
            const [mlStats, setMlStats] = useState({ is_loaded: false, accuracy: 0, n_categories: 0 });

            useEffect(() => {
                loadBatches();
                loadMLStats();
            }, []);

            const loadBatches = async () => {
                try {
                    const response = await api.get('/imports/batches');
                    setBatches(response.data.batches || []);
                } catch (error) {
                    console.error('Erro ao carregar lotes:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadMLStats = async () => {
                try {
                    const response = await api.get('/ml/stats');
                    setMlStats(response.data);
                } catch (error) {
                    console.error('Erro ao carregar estat√≠sticas ML:', error);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-600">üí∞ Planner Financeiro</h1>
                            <div className="flex items-center gap-4">
                                <span className="text-gray-700">{user?.full_name}</span>
                                <button
                                    onClick={onLogout}
                                    className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition"
                                >
                                    Sair
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div
                                onClick={() => onNavigate('import')}
                                className="bg-white p-6 rounded-lg shadow hover:shadow-lg cursor-pointer transition"
                            >
                                <div className="text-4xl mb-4">üìÅ</div>
                                <h2 className="text-xl font-bold mb-2">Importar OFX</h2>
                                <p className="text-gray-600">
                                    Fa√ßa upload de arquivos OFX do seu banco
                                </p>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="text-4xl mb-4">üìä</div>
                                <h2 className="text-xl font-bold mb-2">Lotes Importados</h2>
                                <p className="text-gray-600">
                                    {batches.length} lote(s) processado(s)
                                </p>
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="text-4xl mb-4">ü§ñ</div>
                                <h2 className="text-xl font-bold mb-2">Classifica√ß√£o ML</h2>
                                <p className="text-gray-600">
                                    {mlStats.is_loaded
                                        ? `${Math.round(mlStats.accuracy * 100)}% de acur√°cia, ${mlStats.n_categories} categorias`
                                        : 'Modelo n√£o carregado'}
                                </p>
                            </div>
                        </div>

                        {loading ? (
                            <div className="text-center py-8">Carregando lotes...</div>
                        ) : batches.length > 0 ? (
                            <div className="bg-white rounded-lg shadow overflow-hidden">
                                <div className="px-6 py-4 border-b">
                                    <h2 className="text-xl font-bold">Lotes Recentes</h2>
                                </div>
                                <table className="min-w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arquivo</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Transa√ß√µes</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {batches.slice(0, 5).map((batch) => (
                                            <tr key={batch.id}>
                                                <td className="px-6 py-4 text-sm">{batch.filename}</td>
                                                <td className="px-6 py-4 text-sm">
                                                    {new Date(batch.created_at).toLocaleDateString()}
                                                </td>
                                                <td className="px-6 py-4 text-sm">{batch.total_transactions}</td>
                                                <td className="px-6 py-4 text-sm">
                                                    <span className={`px-2 py-1 rounded text-xs ${
                                                        batch.status === 'completed' ? 'bg-green-100 text-green-800' :
                                                        batch.status === 'review' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {batch.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <div className="bg-white rounded-lg shadow p-8 text-center text-gray-600">
                                Nenhum lote importado ainda. Clique em "Importar OFX" para come√ßar!
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Import OFX Page
        function ImportOFXPage({ onBack }) {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.name.endsWith('.ofx')) {
                    setFile(selectedFile);
                    setError('');
                } else {
                    setError('Por favor, selecione um arquivo .ofx');
                    setFile(null);
                }
            };

            const handleUpload = async () => {
                if (!file) {
                    setError('Selecione um arquivo OFX');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await api.post('/imports/upload', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    setResult(response.data);
                } catch (err) {
                    setError(err.response?.data?.error || 'Erro ao importar arquivo');
                } finally {
                    setLoading(false);
                }
            };

            const handleApprove = async (transactionId, category) => {
                try {
                    await api.put(
                        `/imports/batches/${result.batch.id}/transactions/${transactionId}`,
                        { category, status: 'approved' }
                    );

                    setResult({
                        ...result,
                        pending_transactions: result.pending_transactions.map(t =>
                            t.id === transactionId
                                ? { ...t, review_status: 'approved' }
                                : t
                        )
                    });
                } catch (err) {
                    console.error('Erro ao aprovar transa√ß√£o:', err);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-blue-600">üìÅ Importar OFX</h1>
                            <button
                                onClick={onBack}
                                className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition"
                            >
                                ‚Üê Voltar
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {!result ? (
                            <div className="bg-white rounded-lg shadow p-8 max-w-2xl mx-auto">
                                <h2 className="text-xl font-bold mb-4">Selecione um arquivo OFX</h2>

                                {error && (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                        {error}
                                    </div>
                                )}

                                <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                                    <input
                                        type="file"
                                        accept=".ofx"
                                        onChange={handleFileChange}
                                        className="hidden"
                                        id="file-upload"
                                    />
                                    <label
                                        htmlFor="file-upload"
                                        className="cursor-pointer text-blue-600 hover:text-blue-700"
                                    >
                                        {file ? (
                                            <div>
                                                <div className="text-4xl mb-2">‚úì</div>
                                                <p className="font-medium">{file.name}</p>
                                                <p className="text-sm text-gray-500 mt-2">
                                                    Clique para selecionar outro arquivo
                                                </p>
                                            </div>
                                        ) : (
                                            <div>
                                                <div className="text-4xl mb-2">üìÅ</div>
                                                <p className="font-medium">Clique para selecionar arquivo</p>
                                                <p className="text-sm text-gray-500 mt-2">
                                                    Apenas arquivos .ofx
                                                </p>
                                            </div>
                                        )}
                                    </label>
                                </div>

                                <button
                                    onClick={handleUpload}
                                    disabled={!file || loading}
                                    className="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition"
                                >
                                    {loading ? 'Processando...' : 'ü§ñ Importar e Classificar com ML'}
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h2 className="text-xl font-bold mb-4">‚úÖ Resumo da Importa√ß√£o</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <p className="text-gray-600">Total de Transa√ß√µes</p>
                                            <p className="text-2xl font-bold">{result.summary.transactions.total}</p>
                                        </div>
                                        <div>
                                            <p className="text-gray-600">D√©bitos</p>
                                            <p className="text-2xl font-bold text-red-600">
                                                {result.summary.transactions.debits.count}
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-gray-600">Cr√©ditos</p>
                                            <p className="text-2xl font-bold text-green-600">
                                                {result.summary.transactions.credits.count}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="px-6 py-4 border-b">
                                        <h2 className="text-xl font-bold">Transa√ß√µes Classificadas por ML</h2>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descri√ß√£o</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria ML</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Confian√ßa</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">A√ß√£o</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {result.pending_transactions.map((transaction) => (
                                                    <tr key={transaction.id}>
                                                        <td className="px-6 py-4 text-sm whitespace-nowrap">
                                                            {new Date(transaction.date).toLocaleDateString()}
                                                        </td>
                                                        <td className="px-6 py-4 text-sm">
                                                            {transaction.description.substring(0, 40)}...
                                                        </td>
                                                        <td className={`px-6 py-4 text-sm font-medium whitespace-nowrap ${
                                                            transaction.amount < 0 ? 'text-red-600' : 'text-green-600'
                                                        }`}>
                                                            R$ {Math.abs(transaction.amount).toFixed(2)}
                                                        </td>
                                                        <td className="px-6 py-4 text-sm">
                                                            {transaction.predicted_category}
                                                        </td>
                                                        <td className="px-6 py-4 text-sm">
                                                            <span className={`px-2 py-1 rounded text-xs ${
                                                                transaction.confidence_level === 'high' ? 'bg-green-100 text-green-800' :
                                                                transaction.confidence_level === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-red-100 text-red-800'
                                                            }`}>
                                                                {(transaction.confidence_score * 100).toFixed(0)}%
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 text-sm whitespace-nowrap">
                                                            {transaction.review_status === 'approved' ? (
                                                                <span className="text-green-600">‚úì Aprovado</span>
                                                            ) : (
                                                                <button
                                                                    onClick={() => handleApprove(transaction.id, transaction.predicted_category)}
                                                                    className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
                                                                >
                                                                    Aprovar
                                                                </button>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <button
                                    onClick={() => setResult(null)}
                                    className="w-full bg-gray-600 text-white py-3 px-4 rounded-md hover:bg-gray-700 transition"
                                >
                                    Nova Importa√ß√£o
                                </button>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Main App
        function App() {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [user, setUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('dashboard');

            useEffect(() => {
                const token = localStorage.getItem('access_token');
                const savedUser = localStorage.getItem('user');
                if (token && savedUser) {
                    setIsAuthenticated(true);
                    setUser(JSON.parse(savedUser));
                }
            }, []);

            const handleLoginSuccess = (userData) => {
                setIsAuthenticated(true);
                setUser(userData);
                setCurrentPage('dashboard');
            };

            const handleLogout = () => {
                localStorage.clear();
                setIsAuthenticated(false);
                setUser(null);
                setCurrentPage('dashboard');
            };

            if (!isAuthenticated) {
                return <LoginPage onLoginSuccess={handleLoginSuccess} />;
            }

            if (currentPage === 'import') {
                return <ImportOFXPage onBack={() => setCurrentPage('dashboard')} />;
            }

            return (
                <DashboardPage
                    user={user}
                    onLogout={handleLogout}
                    onNavigate={setCurrentPage}
                />
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
